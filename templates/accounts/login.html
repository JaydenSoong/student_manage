{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Sign in page</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
    <link rel="stylesheet" href="{% static 'css/sweetalert2.min.css' %}">
    <script src="{% static 'js/bootstrap.bundle.min.js' %}" crossorigin="anonymous"></script>
    <script src="{% static 'js/sweetalert2.all.min.js' %}" crossorigin="anonymous"></script>

</head>

<body>
    <div class="theme-toggle-btn">
        <button id="themeToggleBtn" class="btn btn-outline-secondary">
            <i id="themeIcon" class="fa-solid fa-sun"></i>
        </button>
    </div>

    <div class="login-container">
        <h3 class="text-center mb-4">登录</h3>
        <form id="loginForm">
        <div class="container mb-3">
            <label for="role">选择身份</label>
            <div class="row">
                <div class="col">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="role" id="admin" value="admin">
                        <label class="form-check-label" for="admin">
                            管理员
                        </label>
                    </div>
                </div>
                <div class="col">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="role" id="teacher" value="teacher">
                        <label class="form-check-label" for="teacher">
                            教师
                        </label>
                    </div>
                </div>
                <div class="col">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="role" id="student" value="student">
                        <label class="form-check-label" for="student">
                            学生
                        </label>
                    </div>
                </div>
            </div>
        </div>

            {% csrf_token %}
            <div class="mb-3">
                <label for="username" class="form-label">你的手机号:</label>
                <input type="text" id="username" name="username" class="form-control">
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">你的密码:</label>
                <input type="password" class="form-control" id="password" name="password">
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="remember" name="remember" id="remember">
                <label class="form-check-label" for="remember">
                    记住我的密码
                </label>
            </div>
            <button type="button" onclick="submitLogin()" class="btn btn-primary w-100 mb-3">登录</button>
        </form>


        <p class="text-center mt-3">
            <a href="#">忘记密码?</a>
        </p>
    </div>

</body>
<script>
    // 定义一个函数来根据选中的单选项按钮更新标签文本
    function updateLabels() {
        let selectedRoleRadio = document.querySelector('input[name="role"]:checked')
        let usernameLabel = document.querySelector('label[for="username"]')
        let passwordLabel = document.querySelector('label[for="password"]')

        if(selectedRoleRadio) {
            let selectedRole = selectedRoleRadio.value
            switch(selectedRole) {
                case 'admin':
                    usernameLabel.textContent = '用户名:'
                    passwordLabel.textContent = '密码:'
                    break
                case 'teacher':
                    usernameLabel.textContent = '手机号:'
                    passwordLabel.textContent = '密码:'
                    break
                case 'student':
                    usernameLabel.textContent = '学号:'
                    passwordLabel.textContent = '密码:'
                    break
            }
        } else {
            usernameLabel.textContent = '你的账号:'
            passwordLabel.textContent = '你的密码:'
        }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
        let radios = document.querySelectorAll('input[type="radio"][name="role"]')
        radios.forEach(radio => {
            radio.addEventListener('change', updateLabels)
        })
        // 初始调用一次，以适应初始选中状态
        updateLabels()
    })

    function showAlert(title, text) {
        Swal.fire({
            title: title,
            icon: 'error',
            text: text
        })
    }

    function validateForm() {
        // 检查是否有任何单选按钮被选中
        const selectedRoleRadio = document.querySelector('input[name="role"]:checked')
        const username = document.getElementById('username').value
        const password = document.getElementById('password').value
        if(!selectedRoleRadio) {
            showAlert('Oops...', '请选择一个角色')
            return false // 阻止表单提交
        }

        if(!username.length) {
            usernameLabel = document.querySelector('label[for="username"]').textContent.slice(0, -1)
            showAlert('Oops...', usernameLabel + '不能为空')
            return false
        }

        if(password === '') {
            showAlert('Oops...', '密码不能为空')
            return false
        }
        return true //返回 true 表示验证通过
    }

    function submitLogin(){
        // 执行验证，如果未通过则停止执行
        if(!validateForm()) return;
        // 提交表单
        let csrftoken = '{{ csrf_token }}'
        // 获取表单元素
        let formElement = document.getElementById('loginForm')
        // 创建 FormData 对象
        let formData = new FormData(formElement)
        formData.append('csrfmiddlewaretoken', csrftoken)

        fetch('/login/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log(data.messages)
            if(data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: '登录成功',
                    timer: 1500,
                    didClose: () => {
                        if(data.role === 'student') {
                            window.location.href = '{% url "my_score" %}'
                        } else {
                            window.location.href = '/'
                        }
                    }
                })
            } else {
                showAlert('Oops...', data.message)
            }
        })
    }
</script>
</html>