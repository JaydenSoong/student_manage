{%extends 'base.html' %}
{% load custom_filters %}
{% load url_utils %}

{% block content %}
<div class="right col-9">
    <div class="search shadow p-3 mb-5 bg-body-tertiary rounded">
        <form method="get" action="/teachers/">
            <div class="row align-items-center">
                <div class="col-auto">
                    <label for="selectGrade" class="col-form-label">班级：</label>
                </div>
                <div class="col-auto">
                    <select name="grade" class="form-control" id="selectGrade">
                        <option value="" selected="">请选择班级</option>
                        {% for grade in grades %}
                        <option value="{{ grade.pk }}" {% if grade.pk|stringformat:"s" == current_grade %} selected {% endif %}>{{ grade.grade_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto">
                    <label for="search" class="col-form-label">姓名/电话:</label>
                </div>
                <div class="col-auto">
                    <input type="text" name="search" class="form-control form-control-sm" id="search"
                        placeholder="搜索姓名或电话">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary btn-sm">搜索</button>
                </div>
                <div class="col-auto">|</div>
                <div class="col-auto">
                    <button type="button" class="btn btn-success btn-sm" id="add">新增</button>
                </div>
            </div>
        </form>
    </div>

    <div class="list shadow p-3 mb-5 bg-body-tertiary rounded">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th scope="col">序号</th>
                    <th scope="col">班级</th>
                    <th scope="col">姓名</th>
                    <th scope="col">性别</th>
                    <th scope="col">手机号</th>
                    <th scope="col">生日</th>
                    <th scope="col">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for teacher in teachers %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ teacher.grade }}</td>
                    <td>{{ teacher.teacher_name }}</td>
                    <td>{{ teacher.gender|handleGender }}</td>
                    <td>{{ teacher.phone_number }}</td>
                    <td>{{ teacher.birthday }}</td>
                    <td>
                        <a href="{% url 'teacher_update' teacher.id %}" class="link-success edit">编辑</a>
                        <a href="{% url 'teacher_delete' teacher.id %}" class="link-warning del">删除</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-end">
                <li class="page-item"><a href="?{% search_url request page=1 %}" class="page-link">首页</a></li>
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{% search_url request page=page_obj.previous_page_number %}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{% search_url request page=page_obj.number|add:-1 %}">{{ page_obj.number|add:-1 }}</a>
                </li>
                {% endif %}
                <li class="page-item">
                    <a class="page-link active" href="?{% search_url request page=page_obj.number %}">{{ page_obj.number }}</a>
                </li>
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{% search_url request page=page_obj.number|add:1 %}">{{ page_obj.number|add:1 }}</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{% search_url request page=page_obj.next_page_number %}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% endif %}
                <!-- <li class="page-item"><a href="?page={{ page_obj.paginator.num_pages }}" class="page-link">尾页</a></li> -->
                <li class="page-item"><a href="?{% search_url request page=page_obj.paginator.num_pages %}" class="page-link">尾页</a></li>
                <li class="page-item">&nbsp;共 {{page_obj.paginator.num_pages }} 页</li>
            </ul>
        </nav>
    </div>

</div>

{% block scripts %}
<script>
    // 点击新增
    document.getElementById('add').addEventListener('click', () => {
        Swal.fire({
            position: "top-end",
            html: `<iframe src="{% url 'teacher_create' %}" width="100%" height="800px" frameborder="0"></iframe>`,
            width: 600,
            showConfirmButton: false
        })
    })
    // 点击编辑
    document.querySelectorAll('.edit').forEach(button => {
        button.addEventListener('click', function (e) {
            e.preventDefault(); // 阻止跳转
            url = this.getAttribute('href')
            Swal.fire({
                position: "top-end",
                html: `<iframe src="${url}" width="100%" height="800px" frameborder="0"></iframe>`,
                width: 600,
                showConfirmButton: false
            })
        })
    })
    // 点击删除
    document.querySelectorAll('.del').forEach(button => {
        button.addEventListener('click', function (e) {
            e.preventDefault(); // 阻止跳转
            url = this.getAttribute('href')
            Swal.fire({
                title: '确认删除？',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '删除',
                confirmButtonColor: '#d33'
            }).then(result => {
                if (result.isConfirmed) {
                    // 向后台发送数据
                    fetch(url, {
                        method: 'DELETE',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    }).then(response => response.json()).then(data => {
                        if (data.status === 'success') {
                            Swal.fire('Deleted!', data.message, 'success')
                            window.location.reload()
                        }
                        Swal.fire('Error!', data.message, 'error')
                    })
                }
            })
        })
    })
</script>
{% endblock %}

{% endblock%}