{% block scripts %}
<script>
    // 全选
    document.addEventListener('DOMContentLoaded', () => {
        // 获取全选复选框
        const selectAllCheckbox = document.getElementById('select-all')
        // 监听全选复选框点击事件
        selectAllCheckbox.addEventListener('change', () => {
            // 获取所有 name 为 'score_ids' 的复选框
            const studentCheckboxes = document.querySelectorAll('input[name="score_ids"]')
            // 根据全选复选框的状态设置每个学生复选框的状态
            studentCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked
            })
        })
    })
    // 点击新增
    document.getElementById('add').addEventListener('click', () => {
        Swal.fire({
            position: "top-end",
            html: `<iframe src="{% url 'score_create' %}" width="100%" height="800px" frameborder="0"></iframe>`,
            width: 600,
            showConfirmButton: false
        })
    })
    // 点击编辑
    document.querySelectorAll('.edit').forEach(button => {
        button.addEventListener('click', function (e) {
            e.preventDefault(); // 阻止跳转
            url = this.getAttribute('href')
            Swal.fire({
                position: "top-end",
                html: `<iframe src="${url}" width="100%" height="800px" frameborder="0"></iframe>`,
                width: 600,
                showConfirmButton: false
            })
        })
    })
    // 点击删除
    document.querySelectorAll('.del').forEach(button => {
        button.addEventListener('click', function (e) {
            e.preventDefault(); // 阻止跳转
            url = this.getAttribute('href')
            Swal.fire({
                title: '确认删除？',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '删除',
                confirmButtonColor: '#d33'
            }).then(result => {
                if (result.isConfirmed) {
                    // 向后台发送数据
                    fetch(url, {
                        method: 'DELETE',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    }).then(response => response.json()).then(data => {
                        if (data.status === 'success') {
                            Swal.fire('Deleted!', data.message, 'success')
                            window.location.reload()
                        }
                        Swal.fire('Error!', data.message, 'error')
                    })
                }
            })
        })
    })
    // 批量删除
    document.getElementById('del-all').addEventListener('click', () => {
        // 是否有学生被选择
        const checkboxes = document.querySelectorAll('input[name="score_ids"]:checked')
        if (checkboxes.length === 0) {
            Swal.fire({
                title: '错误',
                text: '请先选择要删除的成绩信息',
                icon: 'error',
                confirmButtonText: '好的'
            })
            return;
        }
        // 如果有学生被选中，则 fetch 发送
        Swal.fire({
            title: "确认删除选中的数据？",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '删除',
            confirmButtonColor: '#d33'

        })
            .then(result => {
                if (result.isConfirmed) {
                    // 创建一个表单对象
                    const formData = new FormData()
                    // 遍历所有选择的数据
                    checkboxes.forEach(checkbox => {
                        formData.append('score_ids', checkbox.value)
                    })
                    fetch("{% url 'score_delete_multiple' %}", {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                Swal.fire('Deleted!', data.message, 'success')
                                window.location.reload()
                            }
                            Swal.fire('Error!', data.message, 'error')
                        })
                }
            })
    })
    // 批量导入学生信息
    document.getElementById('import').addEventListener('click', () => {
        Swal.fire({
            title: '上传成绩信息 Excel',
            input: 'file',
            inputAttributes: {
                'accept': '.xlsx',
                'aria-label': 'Upload your excel file'
            },
            showCancelButton: true,
            confirmButtonText: 'Upload',
            showLoaderOnConfirm: true,
            preConfirm: file => {
                // 处理上传的逻辑，例如使用 FormData 和 fetch API 上传
                const formData = new FormData()
                formData.append('excel_file', file)

                return fetch("{% url 'score_import' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': "{{ csrf_token }}"
                    },
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'error') {
                            throw new Error(data.message); // 直接抛出错误，让 catch 块处理
                        }
                    })
                    .catch(error => {
                        Swal.showValidationMessage(`${ error.message || error }`)
                    })
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then(result => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Uploaded!',
                    text: '上传成功'
                })
                window.location.reload();
            }
        })
    })
    // 导出学生信息
    document.getElementById('export').addEventListener('click', () => {
        // 检查是否选择了班级
        var select = document.querySelector('select[name="grade"]')
        var value = select.value
        var gradeText = select.options[select.selectedIndex].text
        if(!value) {
            Swal.fire({
                title: '错误！',
                text: '请选择一个班级',
                icon: 'error',
                confirmButtonText: '确定'
            })
            return ;
        }
        // 提交请求
        Swal.fire({
            title: '确认',
            text: '导出【' + gradeText + '】的成绩信息',
            icon: 'warning',
            showCancelButton: true,
            cancelButtonText: '取消',
            confirmButtonText: '确认'
        }).then(result => {
            if(result.isConfirmed) {
                fetch('{% url "score_export" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ grade: value })
                })
                .then(response=>{
                    if(!response.ok) {
                        response.json().then(result => {
                            Swal.fire({
                                title: '下载失败',
                                text: '服务器错误： ' + result.message,
                                icon: 'error',
                                confirmButtonText: '关闭'
                            })
                        })
                        throw new Error('网络或服务器错误')
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob)
                    const a = document.createElement('a')
                    a.style.display = 'none';
                    a.href = url;
                    a.download = gradeText + '成绩.xlsx'
                    document.body.appendChild(a)
                    a.click()
                    // 清理并移除元素
                    document.body.removeChild(a)
                    window.URL.revokeObjectURL(url)
                })
                .catch(error => {
                    console.error('下载失败', error)
                    Swal.fire({
                        title: '错误',
                        text: '下载出现问题，请稍后再试',
                        icon: 'error',
                        confirmButtonText: '关闭'
                    })
                })
            }
        })
    })
</script>
{% endblock %}